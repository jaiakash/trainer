name: Self Runner Approval Workflow

on:
  pull_request:
    paths:
      - "examples/**"

jobs:
  request-approval:
    if: github.event.pull_request.user.login != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Request approval from @jaiakash
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              ...context.issue,
              body: `ðŸ”’ Changes detected in \`examples\`.

            Hi @jaiakash, please approve by commenting:

            \`\`\`
            /run-gpu-runner
            \`\`\`

            This will trigger the self-runner job on OKE infra.`
                        });

  wait-for-approval:
    needs: request-approval
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Wait for `/run-gpu-runner` from @jaiakash
        uses: peter-evans/wait-for-comments@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          author: "jaiakash"
          body-includes: "/run-gpu-runner"
          wait-timeout: 3600
          check-interval: 15

  run-on-self-hosted:
    name: Run on OKE Self-Hosted Runner
    needs: wait-for-approval
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - run: echo "âœ… Running on OKE self-hosted runner."
